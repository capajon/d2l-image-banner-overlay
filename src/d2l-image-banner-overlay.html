<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../../d2l-typography/d2l-typography.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">

<dom-module id="d2l-image-banner-overlay">
	<template>
		<style include="d2l-typography d2l-typography-shared-styles">
			:host {
				position: absolute;
				height: 100%;
				width: 100%;
				top: 0;
				left: 0;
				z-index: 1;
				@apply(--d2l-body-standard-text);
			}

			.d2l-image-banner-overlay-content {
				opacity: 0;
				transition: opacity 2s;
				width: 100%;
				height: 100%;
			}

			.d2l-image-banner-overlay-content-shown {
				animation-name: shown;
				animation-duration: 0.5s;
				animation-fill-mode: forwards;
			}

			@keyframes shown {
				0% { opacity: 0 }
				100% { opacity: 1; }
			}

			.d2l-image-banner-course-name {
				width: 100%;
				height: 100%;
				background: linear-gradient(rgba(0, 0, 0, 0) 17.5%, black);
			}

			#courseName {
				color: var(--d2l-color-white);
				height: initial;
				position: absolute;
				bottom: 0;
				padding: 0 30px;
    			box-sizing: border-box;
			}
		</style>

		<d2l-ajax auto
			url="[[organizationUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onOrganizationResponse">
		</d2l-ajax>

		<div id="overlayContent" class="d2l-image-banner-overlay-content d2l-typography">
			<div class="d2l-image-banner-course-name">
				<h1 id="courseName" class="d2l-heading-1">[[_courseName]]</h1>
			</div>
		</div>
	</template>
	<script>
		'use strict';
		Polymer({
			is: 'd2l-image-banner-overlay',
			properties: {
				organizationUrl: String,
				_parser: Object,
				_courseName: String
			},
			_organization: Object,
			ready: function() {
				Polymer.dom(this.$.overlayContent).classList.add('d2l-image-banner-overlay-content-shown');
				document.body.addEventListener('set-course-image', this._onSetCourseImage.bind(this));
			},
			_onOrganizationResponse: function(response) {
				if (response.detail.status === 200) {
					this._createParser();
					this._organization = this._parser.parse(response.detail.xhr.response);
					if (this._organization && this._organization.properties) {
						this._courseName = this._organization.properties.name;
					}
				}
			},
			_onSetCourseImage: function(e) {
				this._createParser();
				var org = this._parser.parse(e.detail.organization);

				if (!org.getLinkByRel) { return; }

				var orgSelfLink = (org.getLinkByRel('self') || {}).href || '',
					urlPosition = orgSelfLink.indexOf(this.organizationUrl);

				if (e.detail.status === 'success' &&
					urlPosition === (orgSelfLink.length - this.organizationUrl.length) &&
					e.detail.image
				) {
					var image = this._parser.parse(e.detail.image);
					var imageSrc = this._getDefaultImageLink(image, 'banner');
					var bannerImage = document.querySelector('.d2l-course-banner .d2l-course-banner-image');
					if (bannerImage && imageSrc) {
						bannerImage.src = imageSrc;
						bannerImage.srcset = '';
					}
				}
			},
			_createParser: function() {
				if (!this._parser) {
					this._parser = document.createElement('d2l-siren-parser');
				}
			},
			// lifted from utility-behaviour, if we cut that out we can place it here
			_getImageLinks: function(image, imageClass) {
				var imageLinks = image.getLinksByClass(imageClass || 'tile'),
					sizes = {};
				imageLinks.forEach(function(link) {
					var size = link.hasClass('min') && 'Min' || link.hasClass('mid') && 'Mid' || link.hasClass('max') && 'Max',
						density = link.hasClass('high-density') ? 'high' : 'low';
					sizes[density + size] = link.href;
				});
				return sizes;
			},
			// lifted from utility-behaviour, if we cut that out we can place it here
			getDefaultImageLink: function(image, imageClass) {
				if (!image) {
					return;
				}

				var sizes = this._getImageLinks(image, imageClass);
				return sizes.highMax || sizes.lowMax || sizes.highMid || sizes.lowMid || sizes.highMin || sizes.lowMin;
			},
		});
	</script>
</dom-module>
